<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003" DefaultTargets="Package">
  <PropertyGroup>
    <OpenAPIDefinitionsPath>$(RestSpecFolder)</OpenAPIDefinitionsPath>
    <OpenAPIDefinitionOutputFile>$(DeployFullPath)\awsserverless-deploy.api.yaml</OpenAPIDefinitionOutputFile>
		<AnyRestService>false</AnyRestService>
  </PropertyGroup>
  <ItemGroup>
    <DirsToClean Include="$(OpenAPIDefinitionsPath)" />
  </ItemGroup>
  
  <!--Import Project="$(GX_PROGRAM_DIR)\GeneXus.AWS.targets"/-->

	<Target Name="Validate" Inputs="@(Object)" Outputs="%(Object.Identity)">
		<PropertyGroup>
      <AnyRestService Condition="%(Object.IsRest)==true">true</AnyRestService>
      <AnyWithoutGenerateOpenAPI Condition="%(Object.IsRest)=='true' and %(Object.GenOpenAPI)=='false'">true</AnyWithoutGenerateOpenAPI>
		</PropertyGroup>
	</Target>

	<Target Name="ValidateDeployment" Inputs="@(Object)" Outputs="%(Object.Identity)" DependsOnTargets="Validate">
    <Error Text="Deployment does not include any REST Service (Expose As Rest Service = True)." Condition="$(AnyRestService)==false"/>
    <Error Text="All the objects of the Deployment unit must have Generate OpenAPI Interface property set to True. Alternatively, set to True the property at the generator level, and do a rebuild all." Condition="$(AnyWithoutGenerateOpenAPI)=='true'"/>
  </Target>

  <Target Name="ServerlessOpenAPIGeneration">
    <Message Text="Generating Open API ...." Importance="high"/>
    <ItemGroup>
      <SDObject Include="@(Object)" Condition="('%(Object.Type)' == 'Grid' or '%(Object.Type)' == 'DataProvider') and '%(Object.IsSD)' == 'true' and '%(Object.IsRest)' == 'true' and %(Object.GenOpenAPI)=='true'">
        <QualifiedName Condition="%(Object.Module) != '' and %(Object.ObjectName) != ''">%(Object.Module).%(Object.ObjectName)</QualifiedName>
        <QualifiedName Condition="%(Object.Module) == '' and %(Object.ObjectName) != ''">%(Object.ObjectName)</QualifiedName>
      </SDObject>
    </ItemGroup>

    <OpenKnowledgeBase Directory="$(KBPath)"  />
    <GenerateOpenAPI ObjectList="@(Object -> '%(QualifiedName)');@(SDObject -> '%(QualifiedName)')" OutputFile="$(OpenAPIDefinitionOutputFile)" />
  </Target>
  

</Project>
