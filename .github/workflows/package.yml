name: Build

on:
  push:
    branches: [ master ]
    paths: 
      - src/
      - GeneXus.DeploymentTargets.nuspec
      - .github/

jobs:
  build:
    env:
      NuGetRepository: http://nexus.genexus.com/repository/nuget-prereleases/
    # This will run on our very own servers
    runs-on: armado-virtual

    steps:
    # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
    - name: Checkout the repository
      uses: actions/checkout@v2

    - name: Setup NuGet.exe
      uses: nuget/setup-nuget@v1

    - name: Run the package script
      run: |
        $nuspec = ".\GeneXus.DeploymentTargets.nuspec"
        $xpath = "/package/metadata/version"

        $xml = Select-Xml $nuspec -XPath $xpath

        $packageVersion = $xml.Node.'#text'
        echo "::set-env name=NuGetPackageVersion::$packageVersion"

        Write-Host Packaging GeneXus.DeploymentTargets version $version

        nuget pack $nuspec 

    - name: Push to Nuget Repository
      run: dotnet nuget push GeneXus.DeploymentTargets.$Env.NuGetPackageVersion.nupkg --source $Env:NuGetRepository

    # - name: Checkout private action
    #   uses: actions/checkout@v2
    #   with:
    #       repository: genexuslabs/dispatch-build-result
    #       ref: v1.1
    #       token: ${{ secrets.PAT }}
    #       path: .github/actions/dispatch-build-result
          
    # - name: Dispatch build result
    #   uses: ./.github/actions/dispatch-build-result
    #   with:
    #     new-version: ${{ env.NuGetPackageVersion }}
    #     token: ${{ secrets.PAT }}